<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Tableau de bord Inspecteur hhhh — <%= user.nom %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7f9; --ink:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb;
      --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --bubbleMe:#e7f3ff; --bubbleOther:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2}
    header h1{margin:0;font-size:16px;font-weight:700}
    header .who{color:var(--muted);font-size:12px}
    header .tabs{display:flex;gap:6px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.soft{background:#f1f5f9}
    .layout{display:grid;grid-template-columns:280px 1fr 380px;gap:14px;height:calc(100% - 53px)}
    .sidebar{border-right:1px solid var(--line);background:#fff;display:flex;flex-direction:column;min-height:0}
    .side-head{padding:10px;border-bottom:1px solid var(--line)}
    .select{border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff}
    .tree{padding:8px 6px;overflow:auto;flex:1}
    .node{display:flex;align-items:center;gap:6px;padding:6px;border-radius:8px;cursor:pointer}
    .node:hover{background:#f4f7fb}
    .node.active{background:#e8f5ff;border:1px solid #bee3ff}
    .indent-1{padding-left:12px}
    .indent-2{padding-left:24px}
    .indent-3{padding-left:36px}
    main{padding:12px;overflow:auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .kpi{border:1px dashed var(--line);border-radius:10px;padding:10px;background:#fff}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .n{font-weight:700;font-size:20px}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid var(--line);padding:6px 8px;font-size:12px;text-align:right}
    th:first-child, td:first-child{text-align:left}
    thead th{background:#f8fafc}
    .heat-ok{color:var(--ok);font-weight:600}
    .heat-warn{color:#b45309;font-weight:600}
    .heat-bad{color:#ef4444;font-weight:600}
    .empty{padding:12px;border:1px dashed var(--line);border-radius:10px;background:#fff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tabsR{display:flex;gap:10px;border-bottom:1px solid var(--line);margin-bottom:10px}
    .tabsR .tab{padding:6px 8px;border-bottom:2px solid transparent;cursor:pointer}
    .tabsR .tab.active{border-bottom-color:var(--brand);color:#0b5cc4}
    .scroll{max-height:520px;overflow:auto}
    .chat{display:flex;flex-direction:column;height:520px}
    .msgs{border:1px solid var(--line);border-radius:10px;flex:1;overflow:auto;padding:10px;background:#fbfcfe;margin-bottom:8px}
    .bubble{max-width:78%;padding:8px 10px;border-radius:14px;margin:6px 0;position:relative;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .me{margin-left:auto;background:var(--bubbleMe)}
    .other{margin-right:auto;background:var(--bubbleOther)}
    .bubble .from{font-weight:700;margin-bottom:2px}
.bubble .reply{border-left:3px solid #93c5fd;background:#f0f7ff;padding:6px 8px;border-radius:8px;margin-bottom:6px;font-size:12px;color:#475569}
.msgActions{display:flex;gap:8px;margin-top:2px;font-size:12px;color:#64748b}
.msgActions .link{cursor:pointer;text-decoration:underline}
.inspTag{font-size:11px;color:#6b7280;margin-left:6px}
/* zone messages – même rendu que côté AP, sans hauteur fixe */
.wchat .w-msgs{
  border:1px solid #e5e7eb;
  border-radius:10px;
  margin-top:8px;
  overflow:auto;
  padding:10px;
  background:#e5ddd5;
  background-image:
    radial-gradient(rgba(0,0,0,.035) 0.5px, transparent 0.5px),
    radial-gradient(rgba(0,0,0,.035) 0.5px, transparent 0.5px);
  background-position: 0 0, 12px 12px;
  background-size: 24px 24px;
}

    .bubble small{display:block;margin-top:4px;color:#64748b;font-size:11px;text-align:right}
    .composer{display:flex;gap:8px}
    .composer input[type=text]{flex:1;padding:10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .composer .btn{border-radius:999px}
    .mail{border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0;cursor:pointer;background:#fff}
    .mail:hover{background:#f8fbff}
    .mail .sub{font-size:12px;color:var(--muted)}
    .mail .sujet{font-weight:600}
    .badge{padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:11px;margin-left:6px;color:#555}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .panel{width:min(980px,94vw);max-height:92vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .panel h3{margin:0 0 6px 0}
    .tabs2{display:flex;gap:8px;border-bottom:1px solid var(--line);margin:8px 0}
    .tabs2 .t{padding:6px 8px;border-bottom:2px solid transparent;cursor:pointer}
    .tabs2 .t.active{border-bottom-color:var(--brand);color:#0b5cc4}
    .closeX{margin-left:auto;cursor:pointer;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;background:#fff}
    .fileRow{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid var(--line);border-radius:8px;margin:6px 0;background:#fff}
    .fileRow a{font-weight:600}
    .fileRow .del{margin-left:auto}
    @media (max-width:1200px){ .kpis{grid-template-columns:repeat(3,1fr);} .layout{grid-template-columns:1fr} }
    /* ===== WhatsApp-like chat (aligné sur AP) ===== */
.wchat .w-header{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#075e54;color:#fff}
.wchat .w-name{font-weight:700}
.wchat .w-sub{font-size:12px;opacity:.9}
.wchat .w-avatar{width:34px;height:34px;border-radius:50%;background:#25d366;display:flex;align-items:center;justify-content:center;font-weight:800}

.w-day{display:inline-block;margin:10px auto 4px;padding:3px 10px;border-radius:999px;background:rgba(0,0,0,.08);font-size:11px}
.w-msg{display:flex;gap:6px;margin:8px 0;align-items:flex-end}
.w-avatar-sm{width:24px;height:24px;border-radius:50%;background:#c8e6c9;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#2e7d32}
.w-bubble{max-width:78%;padding:8px 10px;border-radius:14px;box-shadow:0 1px 1px rgba(0,0,0,.06)}
.w-msg.theirs .w-bubble{background:#fff;border-top-left-radius:4px}
.w-msg.mine{justify-content:flex-end}
.w-msg.mine .w-bubble{background:#dcf8c6;border-top-right-radius:4px}
.w-from{font-size:11px;color:#075e54;margin:0 0 2px 2px;font-weight:700}
.w-msg.mine .w-from{color:#0a6e56}
.w-text{white-space:pre-wrap;word-wrap:break-word}
.w-meta{font-size:10px;opacity:.7;text-align:right;margin-top:3px;display:flex;gap:6px;justify-content:flex-end}
.w-ticks{font-weight:700}

/* Quote (reply) */
.w-quote{border-left:3px solid #34b7f1;background:rgba(255,255,255,.7);padding:6px 8px;border-radius:8px;margin-bottom:6px;cursor:pointer}
.w-quote .q-name{font-size:11px;font-weight:700;margin-bottom:2px;color:#1f2937}
.w-quote .q-text{font-size:12px;color:#374151}

/* Barre “Répondre à …” */
.w-replybar{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#f1f5f9;margin-top:6px}
.w-replybar .name{font-weight:700}
.w-replybar .snippet{font-size:12px;color:#475569}
.w-replybar .close{margin-left:auto;border:none;background:#e11d48;color:#fff;border-radius:6px;padding:4px 8px;cursor:pointer}

/* Champ de saisie */
.w-input{display:flex;gap:6px;align-items:center;margin-top:8px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 8px;background:#fff}
.w-input .icon{border:none;background:transparent;cursor:pointer;font-size:18px}
.w-input input[type=text]{flex:1;border:none;outline:0;font-size:14px}
.w-input .send{border:none;border-radius:50%;width:34px;height:34px;background:#128c7e;color:#fff;font-weight:800;cursor:pointer}

/* Surlignage quand on ouvre une citation */
.flash{animation:flash 1.8s ease 1}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(255,238,0,.9)}100%{box-shadow:0 0 0 0 transparent}}
/* utilitaires */
.hidden{display:none !important}

/* typing (même rendu que côté AP) */
.typing{height:14px;font-size:11px;margin:4px 0;color:#64748b}

/* pane chat doit être flex pour que l’onglet 'Chat' l’affiche correctement */
#paneChat{display:flex;flex-direction:column}

/* même logique que l'ancien .chat : le composant occupe 520px */
.wchat{display:flex;flex-direction:column;height:520px}
.wchat .w-msgs{flex:1;height:auto} /* pas de hauteur fixe 260px, on laisse flex prendre la place */
.w-avatar-sm{
  width:24px; height:24px; border-radius:50%;
  display:inline-flex; align-items:center; justify-content:center;
  background:#c8e6c9; color:#2e7d32; font-weight:800; font-size:11px;
  text-transform:uppercase; user-select:none;
}

/* pager dépôts */
.pager{display:flex;align-items:center;gap:8px;margin-top:8px}
.pager .btn{padding:4px 10px}
.pager .muted{font-size:12px}

/* toast léger */
.toast {
  position: fixed; right: 14px; bottom: 14px; z-index: 9999;
  background:#111827; color:#fff; padding:10px 12px;
  border-radius:10px; font-size:13px; box-shadow:0 8px 24px rgba(0,0,0,.2);
  opacity:0; transform: translateY(8px); transition:.2s;
}
.toast.show{ opacity:1; transform: translateY(0); }
.text-center{ text-align:center; }
.text-end{ text-align:right; }


.btn.mini{ padding:2px 6px; font-size:11px; border-radius:999px }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Tableau de bord Inspecteur — <span class="who"><%= (user.inspection||'').toUpperCase() %> • <%= user.nom %></span></h1>
    </div>
    <div class="tabs">
      <a href="/inspector" class="btn primary">Synthèse</a>
      <a href="/inspector/carte" class="btn">Carte scolaire</a>
      <a href="/fichiers" class="btn">Échanges</a>
        <a id="btnStaff" href="/inspecteur/enseignants" class="btn">Fichier personnel</a>
      <form action="/auth/logout" method="post" style="display:inline"><button class="btn">Déconnexion</button></form>
    </div>
  </header>

  <div class="layout">
    <!-- ======== Sidebar gauche : Explorateur ======== -->
    <aside class="sidebar">
      <div class="side-head">
        <div style="font-weight:700">Explorateur (découvert depuis les dépôts)</div>
        <div class="row" style="margin-top:8px">
          <select id="period" class="select">
            <option value="ann">Annuel</option>
            <option value="eval">Évaluation…</option>
            <option value="tri">Trimestre…</option>
          </select>
          <select id="selEval" class="select" style="display:none">
            <option value="1">Éval 1</option><option value="2">Éval 2</option>
            <option value="3">Éval 3</option><option value="4">Éval 4</option>
            <option value="5">Éval 5</option><option value="6">Éval 6</option>
          </select>
          <select id="selTri" class="select" style="display:none">
            <option value="T1">T1 (1+2)</option>
            <option value="T2">T2 (3+4)</option>
            <option value="T3">T3 (5+6)</option>
          </select>
        </div>
      </div>
      <div class="tree" id="tree"><!-- rempli par JS --></div>
    </aside>

    <!-- ================== Centre ================== -->
    <main>
      <!-- KPIs -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>KPIs <span id="kpiScope" class="muted">Annuel — Toute la région</span></strong>
          <div class="legend muted">
            <span>Couleur des % :</span>
            <span class="heat-ok">≥ 75%</span>
            <span class="heat-warn">50–74%</span>
            <span class="heat-bad">&lt; 50%</span>
          </div>
        </div>
        <div class="kpis" style="margin-top:8px">
          <div class="kpi"><div class="label">Établissements</div><div class="n" id="kEtab">—</div></div>
          <div class="kpi"><div class="label">AP actifs</div><div class="n" id="kAP">—</div></div>
          <div class="kpi"><div class="label">Dépôts comptés</div><div class="n" id="kDepots">—</div></div>
          <div class="kpi"><div class="label">Élèves (≈)</div><div class="n" id="kEleves">—</div></div>
          <div class="kpi"><div class="label">Ens. en poste (≈)</div><div class="n" id="kEns">—</div></div>
          <div class="kpi"><div class="label">Heures %</div><div class="n" id="kH">—</div></div>
          <div class="kpi"><div class="label">Leçons %</div><div class="n" id="kL">—</div></div>
          <div class="kpi"><div class="label">Leçons dig. %</div><div class="n" id="kLd">—</div></div>
          <div class="kpi"><div class="label">TP %</div><div class="n" id="kTp">—</div></div>
          <div class="kpi"><div class="label">TP dig. %</div><div class="n" id="kTd">—</div></div>
          <div class="kpi"><div class="label">Réussite %</div><div class="n" id="kR">—</div></div>
        </div>
      </div>

      <!-- Synthèse -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Disciplines de la sélection</strong>
          <div class="row">
            <button class="btn soft" id="btnCsv">Export CSV</button>
            <button class="btn primary" id="btnPrint">Imprimer</button>
          </div>
        </div>
        <div id="syn" style="margin-top:8px" class="empty">Sélectionne à gauche un niveau (cycle, spécialité ou classe) pour voir la synthèse.</div>
      </div>

      <!-- Carte scolaire régionale (récap) -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Carte scolaire — région</strong>
          <div class="row">
            <button class="btn soft" id="btnExportMap">Export CSV</button>
            <button class="btn primary" id="btnPrintMap">Imprimer</button>
            <button class="btn" id="btnPurgeCards" title="Supprimer des cartes scolaires">Purger cartes…</button>
            
          </div>
        </div>
        <div id="schoolMap" style="margin-top:8px" class="empty">Aucune donnée (sélectionne un périmètre ou laisse “Toute la région”).</div>
      </div>

      <!-- Incohérences -->
      <div class="card">
        <strong>Incohérences détectées</strong>
        <div id="inc" style="margin-top:8px" class="empty">Aucune analyse encore (sélectionne un périmètre).</div>
      </div>
    </main>

    <!-- ================ Sidebar droite : Chat + Dépôts ================ -->
    <aside class="sidebar" style="border-left:1px solid var(--line);border-right:none">
      <div class="side-head">
        <div class="tabsR">
          <div id="tabChat"   class="tab active">Chat</div>
          <div id="tabDepots" class="tab">Dépôts reçus</div>
        </div>
      </div>

      <!-- CHAT -->
      <!-- CHAT -->
<div id="paneChat" style="padding:10px">
  <div class="wchat">
    <div class="w-header">
      <div class="w-avatar"><%= ((user && user.nom) || 'IPR').split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase() %></div>
      <div>
        <div class="w-name"><%= (user && user.nom) || '—' %> <span class="inspTag">(Inspecteur)</span></div>
        <div class="w-sub" id="presence">Connectés : —</div>
      </div>
      <div style="margin-left:auto"><button class="btn" id="chatRefresh" type="button">↻</button><% if (user && user.role === 'insp') { %>
      <button class="btn" id="chatResetBtn" type="button" title="Purger l’historique du salon">🗑️</button>
    <% } %></div>
    </div>

    <div id="msgs" class="w-msgs"></div>
    <div id="typing" class="typing"></div>

    <!-- Barre “répondre à …” -->
    <div id="replyBar" class="w-replybar hidden" aria-live="polite">
      <div>
        <div class="name" id="replyName">—</div>
        <div class="snippet" id="replySnippet">—</div>
      </div>
      <button class="close" id="replyCancel" type="button">Annuler</button>
    </div>

    <form id="chatForm" class="w-input" autocomplete="off">
      <button class="icon" type="button" id="emojiBtn" title="Emoji">🙂</button>
      <input id="chatText" type="text" placeholder="Tapez un message… (Entrée = envoyer, Shift+Entrée = ligne)">
      <input id="chatFile" type="file" class="hidden">
      <button class="icon" type="button" id="attachBtn" title="Joindre">📎</button>
      <button class="send" type="submit" title="Envoyer">➤</button>
    </form>

    <div class="muted" style="margin-top:6px">Salon commun IPR ⇄ AP de l’inspection.</div>
  </div>
</div>


      <!-- DEPOTS (mailbox) -->
     <div id="paneDepots" style="display:none;padding:10px">
  <div class="row" style="margin-bottom:6px">
    <span class="muted">Filtré par la période & la sélection à gauche.</span>
    <button class="btn soft" id="btnRefreshDepots" style="margin-left:auto">Rafraîchir</button>
  </div>
  <div id="mailList" class="scroll"></div>
  <div id="mailEmpty" class="empty" style="display:none">Aucun dépôt trouvé pour ce périmètre.</div>

  <!-- PAGER -->
  <div class="pager">
    <button class="btn" id="depPrev">◀</button>
    <button class="btn" id="depNext">▶</button>
    <span class="muted" id="depInfo">—</span>
    <select id="depLimit" class="select" title="Nombre par page">
      <option>10</option><option selected>20</option><option>50</option><option>100</option>
    </select>
  </div>
</div>


  <!-- ====== Overlay consultation d'un dépôt / Détails établissement ====== -->
  <div id="ov" class="overlay">
    <div class="panel">
      <div class="row" style="align-items:center;margin-bottom:4px">
        <h3 id="ovTitle">Dépôt</h3>
        <button id="ovClose" class="closeX">Fermer</button>
      </div>
      <div id="ovMeta" class="muted" style="margin-bottom:8px"></div>

      <div class="tabs2">
        <div id="tabOverview" class="t active">Aperçu</div>
        <div id="tabClasses"  class="t">Classes & modules</div>
        <div id="tabFiles"    class="t">Pièces jointes</div>
        <div id="tabRaw"      class="t">Brut (JSON)</div>
      </div>

      <div id="paneOverview"></div>
      <div id="paneClasses"  style="display:none"></div>
      <div id="paneFiles"    style="display:none"></div>
      <div id="paneRaw"      style="display:none"><pre id="rawJson" style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:8px"></pre></div>
    </div>
  </div>

<!-- ===== Modale Purge Cartes ===== -->
<div id="purgeModal" class="overlay" style="display:none">
  <div class="panel">
    <div class="row" style="align-items:center;margin-bottom:4px">
      <h3 style="margin:0">Purger des cartes scolaires</h3>
      <button id="purgeClose" class="closeX">Fermer</button>
    </div>

    <div class="row" style="gap:8px;margin-bottom:8px">
      <input id="purgeYear" class="select" type="text" placeholder="Année ex: 2025-2026" style="width:170px">
      <input id="purgeFilter" class="select" type="text" placeholder="Filtrer établissement…" style="flex:1">
      <label><input id="purgeChkAll" type="checkbox"> Tout cocher</label>
      <button id="purgeReload" class="btn soft">Recharger</button>
      <button id="purgeDo" class="btn primary">Supprimer la sélection</button>
    </div>

    <div style="overflow:auto;max-height:60vh">
      <table id="purgeTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#f8fafc">
            <th style="text-align:center">Sel.</th>
            <th>Établissement</th>
            <th>Année</th>
            <th>Cycle</th>
            <th>Spécialité</th>
            <th>Version</th>
            <th>Reçue le</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="purgeEmpty" class="empty" style="display:none;margin-top:8px">Aucune carte trouvée.</div>
    </div>
  </div>
</div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    /* eslint-env browser */
  /* global io */
    /* ========= helpers ========= */
    const esc=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    const pct=(d,n)=> d>0 ? (n/d*100) : 0;
    const fmt=v=> (isFinite(v)&&v>0) ? v.toFixed(1)+'%' : '0%';
    const heat=v=> v>=75?'heat-ok':(v>=50?'heat-warn':'heat-bad');
let GLOBAL_KPI = null;
    function printElement(el, title='Impression'){
      const w=window.open('','_blank','width=1200,height=800');
      const style=document.querySelector('style').outerHTML;
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${esc(title)}</title>${style}</head><body>${el.outerHTML}</body></html>`);
      w.document.close(); w.focus(); w.print(); w.close();
    }
    function tableToCsv(table){
      const rows=[...table.querySelectorAll('tr')];
      return rows.map(tr=>[...tr.children].map(td=>{
        const s=td.textContent.trim().replace(/\s+/g,' ');
        return /[",;\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
      }).join(';')).join('\n');
    }
    function downloadCsv(csv, filename){
      const b=new Blob([csv],{type:'text/csv;charset=utf-8;'});const u=URL.createObjectURL(b);
      const a=document.createElement('a'); a.href=u; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    }

    function toast(msg){
  const t = document.getElementById('toast');
  if (!t) return alert(msg);
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1600);
}
// ===== Année scolaire depuis l'URL =====
const URL_QS = new URLSearchParams(location.search);
const ANNEE  = URL_QS.get('annee') || '';

// QS commun : période (annuel/éval/tri) + année (si fournie)
function currentQS(){
  return { ...currentPeriodQS(), ...(ANNEE ? { annee: ANNEE } : {}) };
}
    // ===== Période
    const period=document.getElementById('period'), selEval=document.getElementById('selEval'), selTri=document.getElementById('selTri');
    function currentPeriodQS(){ const m=period.value; if(m==='eval') return { evaluation:selEval.value }; if(m==='tri') return { trimestre:selTri.value }; return {}; }
    function currentPeriodLabel(){ const m=period.value; if(m==='eval') return `Évaluation ${selEval.value}`; if(m==='tri') return selTri.value; return 'Annuel'; }
    period.addEventListener('change', ()=>{ selEval.style.display=(period.value==='eval')?'inline-block':'none'; selTri.style.display=(period.value==='tri')?'inline-block':'none'; _activeNode && renderForNode(_activeNode); });
    selEval.addEventListener('change', ()=> _activeNode && renderForNode(_activeNode));
    selTri .addEventListener('change', ()=> _activeNode && renderForNode(_activeNode));

    // ===== API helpers
    async function api(path){ const r=await fetch(path,{credentials:'same-origin'}); if(!r.ok) throw new Error('HTTP'); return r.json(); }

    // --- (existant) utilisé par la synthèse "form-view"
    async function fetchByEtab(cycle,spec,qs){
      const q=new URLSearchParams({ cycle, specialite:spec, ...(qs||{}) });
      return api('/api/summary/by-etab?'+q.toString());
    }

    // --- API Carte scolaire
    async function loadCarteInspection(filter, qs){
      const q = new URLSearchParams({ ...(filter||{}), ...(qs||{}) }).toString();
      return api('/api/inspecteur/carte/inspection?'+q);
    }
   async function openEtabDetails(etab, annee){
  const etabClean = htmlUnescape(etab);
  // 1) On récupère UNIQUEMENT les dernières cartes par (cycle, spécialité) pour cet établissement et cette année
  const qsLatest = new URLSearchParams({ etablissement: etabClean, ...(annee ? { annee } : {}) });
  const latest = await api('/api/inspecteur/carte-scolaire/latest?' + qsLatest.toString())
                .catch(()=>({ rows: [] }));

  const rows = Array.isArray(latest?.rows) ? latest.rows : [];

  // 2) On agrège les données "propres" (latest only)
  const allStaff = [];
  const effMap   = new Map(); // classe -> {classe, filles, garcons}

  for (const row of rows){
    // selon ton backend: les cartes ont souvent `data` ou des champs plats
    const src = row?.data || row;

    // effectifs
    const eff = Array.isArray(src?.effectifs) ? src.effectifs : [];
    for (const e of eff){
      const k = String(e?.classe || '').trim();
      const f = Number(e?.filles)  || 0;
      const g = Number(e?.garcons) || 0;
      const prev = effMap.get(k) || { classe:k, filles:0, garcons:0 };
      prev.filles  += f;
      prev.garcons += g;
      effMap.set(k, prev);
    }

    // staff
    const staff = Array.isArray(src?.staff) ? src.staff
                : Array.isArray(src?.enseignants) ? src.enseignants
                : Array.isArray(src?.personnel) ? src.personnel
                : Array.isArray(src?.teachers) ? src.teachers
                : [];
    allStaff.push(...staff);
  }

  // 3) Dédoublonnage staff (clé composite robuste)
  const staffDedup = Array.from(new Map(allStaff.map(p=>{
    const key = [
      (p.nom||'').trim().toLowerCase(),
      (p.matiere||'').trim().toLowerCase(),
      (p.grade||'').trim().toLowerCase(),
      (p.statut||p.status||'').trim().toLowerCase()
    ].join('|');
    return [key, p];
  })).values());

  // 4) Rendu
 ovTitle.textContent = `Détails — ${etabClean}`;
  ovMeta.innerHTML = `<div><strong>Année:</strong> ${esc(annee||'—')}</div>`;

  const effectifs = Array.from(effMap.values()).sort((a,b)=> (a.classe||'').localeCompare(b.classe||''));

  const effRows = effectifs.map(e=>`
    <tr>
      <td>${esc(e.classe||'')}</td>
      <td>${Number(e.filles)||0}</td>
      <td>${Number(e.garcons)||0}</td>
      <td><b>${(Number(e.filles)||0)+(Number(e.garcons)||0)}</b></td>
    </tr>`).join('');

  const staffRows = staffDedup.map(p=>`
    <tr>
      <td>${esc(p.nom||'')}</td>
      <td>${esc(p.grade||'')}</td>
      <td>${esc(p.matiere||'')}</td>
      <td>${esc(p.statut||p.status||'')}</td>
      <td>${(p.classes||[]).map(c=>`<span class="badge">${esc(c)}</span>`).join(' ')||'—'}</td>
      <td>${(p.disciplines||[]).map(x=>`<span class="badge">${esc(x)}</span>`).join(' ')||'—'}</td>
      <td>${esc(p.obs||'')}</td>
    </tr>`).join('');

  // panneau
  const cyclesSpecs = rows.map(r=>{
    const m = r?.meta || r?.data?.meta || {};
    return [m.cycle, (m.specialite||'').toString().toUpperCase()].filter(Boolean).join(' / ');
  }).filter(Boolean);

  paneOverview.innerHTML = `
    <div class="muted" style="margin-bottom:8px">
      ${rows.length} carte(s) la plus récente par couple (cycle, spécialité) — ${esc(cyclesSpecs.join(', ')||'—')}
    </div>
    <h3 style="margin:8px 0 6px">Effectifs par classe</h3>
    <table>
      <thead><tr><th>Classe</th><th>Filles</th><th>Garçons</th><th>Total</th></tr></thead>
      <tbody>${effRows || '<tr><td colspan="4" class="muted">—</td></tr>'}</tbody>
    </table>
    <h3 style="margin:12px 0 6px">Personnel enseignant (${staffDedup.length})</h3>
    <table>
      <thead><tr><th>Nom</th><th>Grade</th><th>Matière</th><th>Statut</th><th>Classes</th><th>Disciplines</th><th>Obs.</th></tr></thead>
      <tbody>${staffRows || '<tr><td colspan="7" class="muted">—</td></tr>'}</tbody>
    </table>
  `;

  // “Brut” pour debug : on montre ce qu'on a réellement utilisé (latest only)
  rawJson.textContent = JSON.stringify(rows, null, 2);

  setOvTab('overview');
  ov.style.display='flex';
}


    // ===== Explorateur dynamique
    const tree=document.getElementById('tree'); let _topology=null, _activeNode=null;
    function nodeTpl({id,label,indent=0,meta,active}){ return `<div class="node indent-${indent} ${active?'active':''}" data-id="${id}" data-meta='${JSON.stringify(meta)}'>${esc(label)}</div>`; }
    async function buildTree(){
      tree.innerHTML='';
      try{ _topology = await api('/api/summary/topology'); }catch(_){ _topology={cycles:[]}; }
      tree.insertAdjacentHTML('beforeend', nodeTpl({id:'region',label:'🌍 Toute la région',indent:0,meta:{type:'region'},active:true}));
      _activeNode={ id:'region', meta:{type:'region'}, label:'Toute la région' };

      (_topology.cycles||[]).forEach(c=>{
        tree.insertAdjacentHTML('beforeend',nodeTpl({id:`c:${c.key}`,label:c.label||c.key,indent:1,meta:{type:'cycle',cycle:c.key}}));
        (c.specialites||[]).forEach(s=>{
          tree.insertAdjacentHTML('beforeend',nodeTpl({id:`c:${c.key}|s:${s.key}`,label:s.key,indent:2,meta:{type:'spec',cycle:c.key,spec:s.key}}));
          (s.classes||[]).forEach(cl=>{
            tree.insertAdjacentHTML('beforeend',nodeTpl({id:`c:${c.key}|s:${s.key}|cl:${cl}`,label:cl,indent:3,meta:{type:'class',cycle:c.key,spec:s.key,classe:cl}}));
          });
        });
      });

      tree.addEventListener('click', e=>{
        const el=e.target.closest('.node'); if(!el) return;
        tree.querySelectorAll('.node').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
        _activeNode={ id:el.dataset.id, meta:JSON.parse(el.dataset.meta||'{}'), label:el.textContent.trim() };
        renderForNode(_activeNode);
      });

      renderForNode(_activeNode);

      const depId = sessionStorage.getItem('openDepositId');
      if (depId) { sessionStorage.removeItem('openDepositId'); openDeposit(depId); }
    }

    // ===== KPIs + Synthèse + Carte scolaire + Dépôts
    const kScope=document.getElementById('kpiScope');
    const kE=document.getElementById('kEtab'), kAP=document.getElementById('kAP'), kD=document.getElementById('kDepots'),
          kEl=document.getElementById('kEleves'), kEns=document.getElementById('kEns'),
          kH=document.getElementById('kH'), kL=document.getElementById('kL'), kLd=document.getElementById('kLd'),
          kTp=document.getElementById('kTp'), kTd=document.getElementById('kTd'), kR=document.getElementById('kR');

    const syn=document.getElementById('syn'), inc=document.getElementById('inc'), mapBox=document.getElementById('schoolMap');

    function headForm(labelFirst){ return `<thead>
      <tr>
        <th rowspan="2">${labelFirst}</th>
        <th colspan="3">Couverture des heures</th>
        <th colspan="6">Couverture des programmes</th>
        <th colspan="6">Réalisation des TP</th>
        <th colspan="3">Réussite des élèves</th>
        <th colspan="3">Assiduité et ponctualité des enseignants</th>
      </tr>
      <tr>
        <th>Heures dues</th><th>Heures faites</th><th>%</th>
        <th>Nbre de leçons prévues</th><th>Nbre de leçons faites</th><th>%</th>
        <th>Nbre de leçons digitalisées prévues</th><th>Nbre de leçons digitalisées faites</th><th>%</th>
        <th>Nbre prévu</th><th>Nbre fait</th><th>%</th>
        <th>Nbre digitalisé prévu</th><th>Nbre digitalisé fait</th><th>%</th>
        <th>Nbre d'élèves ayant composé</th><th>Nbre de moy ≥ 10/20</th><th>% de réussite</th>
        <th>Effectif des enseignants</th><th>En poste</th><th>%</th>
      </tr>
    </thead>`; }

    function discRow(d){
      const H=pct(d.Hd||0,d.Hf||0), L=pct(d.Lp||0,d.Lf||0), Ld=pct(d.Ldp||0,d.Ldf||0),
            Tp=pct(d.Tp||0,d.Tf||0), Td=pct(d.Tdp||0,d.Tdf||0), R=pct(d.Comp||0,d.M10||0), A=pct(d.EffT||0,d.EffP||0);
      return `<tr>
        <td>${esc(d.nom||d.discipline||'')}</td>
        <td>${d.Hd||0}</td><td>${d.Hf||0}</td><td class="${heat(H)}">${fmt(H)}</td>
        <td>${d.Lp||0}</td><td>${d.Lf||0}</td><td class="${heat(L)}">${fmt(L)}</td>
        <td>${d.Ldp||0}</td><td>${d.Ldf||0}</td><td class="${heat(Ld)}">${fmt(Ld)}</td>
        <td>${d.Tp||0}</td><td>${d.Tf||0}</td><td class="${heat(Tp)}">${fmt(Tp)}</td>
        <td>${d.Tdp||0}</td><td>${d.Tdf||0}</td><td class="${heat(Td)}">${fmt(Td)}</td>
        <td>${d.Comp||0}</td><td>${d.M10||0}</td><td class="${heat(R)}">${fmt(R)}</td>
        <td>${d.EffT||0}</td><td>${d.EffP||0}</td><td class="${heat(A)}">${fmt(A)}</td>
      </tr>`;
    }

    /* ---------- Helpers staff / statut EN POSTE ---------- */
    function getStaffArray(row){
      if (Array.isArray(row.staff)) return row.staff;
      if (Array.isArray(row.enseignants)) return row.enseignants;
      if (Array.isArray(row.personnel)) return row.personnel;
      if (Array.isArray(row.teachers)) return row.teachers;
      return [];
    }
    function isEnPoste(p){
      if (typeof p?.enPoste === 'boolean') return p.enPoste;
      const s = (p?.statut || p?.status || '')
        .toString()
        .normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .trim()
        .toLowerCase();
      const positif = /(titulaire|en poste|actif|present|affecte)/.test(s);
      const negatif = /(vacataire|absent|retire|sorti)/.test(s);
      return positif && !negatif;
    }
function htmlUnescape(s){
  const div = document.createElement('div');
  div.innerHTML = String(s ?? '');
  return div.textContent || '';
}


    /* ----------------------------------------------------- */

    /* ===== Cache + fallback par établissement ===== */
    /* ===== Cache + fallback par établissement ===== */
const etabCache = new Map(); // clé: `${etab}|${annee}` -> {tot, pos}
async function getEtabStaffCounts(name){
  if (!name) return {tot:0, pos:0};
  const key = `${name}|${ANNEE||''}`;
  if (etabCache.has(key)) return etabCache.get(key);
  try{
    const q = new URLSearchParams({ etablissement: name, ...(ANNEE ? { annee: ANNEE } : {}) });
    const d = await api('/api/inspecteur/carte/etab?' + q.toString());
    const staff = getStaffArray(d) || getStaffArray(d?.data||{}) || d?.staff || [];
    const tot = Array.isArray(staff) ? staff.length : 0;
    const pos = Array.isArray(staff) ? staff.filter(isEnPoste).length : 0;
    const val = {tot, pos};
    etabCache.set(key, val);
    return val;
  }catch(_){
    const val = {tot:0, pos:0};
    etabCache.set(key, val);
    return val;
  }
}

function renderLowProgressTable(rows){
  const host = document.getElementById('inc');
  const top = [...rows].slice(0, 10);

  const body = top.length ? top.map(r=>`
    <tr>
      <td>${esc(r.etablissement||'')}</td>
      <td class="text-center">${r.ap||0}</td>
      <td class="text-center">${r.received||0} / ${r.expected||0}</td>
      <td class="${heat(Number(r.rate)||0)}" style="text-align:right">${isFinite(r.rate)?r.rate.toFixed(1):'0.0'}%</td>
      <td><button class="btn soft mini" data-open-etab="${esc(r.etablissement||'')}">Détails</button></td>
    </tr>`).join('')
  : `<tr><td colspan="5" class="muted">Aucun établissement dans le périmètre.</td></tr>`;

  const html = `
    <section id="lowProgress">
      <h4 style="margin:12px 0 6px">Établissements à <em>faible progression</em> (dépôts reçus / attendus)</h4>
      <table class="table table-sm table-bordered align-middle">
        <thead>
          <tr>
            <th>Établissement</th>
            <th>AP actifs</th>
            <th>Reçus / Attendus</th>
            <th style="width:120px">% progression</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </section>
  `;

  const old = host.querySelector('#lowProgress');
  if (old) old.outerHTML = html;
  else host.insertAdjacentHTML('beforeend', html);
}


// Combine/format pourcentages établissement
function normalizePct(x){ const n = Number(x); return Number.isFinite(n) ? Math.max(0, Math.min(100, n)) : 0; }

// Calcule un score moyen (heures, leçons, leçons dig., TP, TP dig.), sans compter “A” ni “R” ici
function makeLowWorkRows(byEtabRows){
  // rows: [{ etablissement, H, Pc, Pd, Tc, Td, ... }]
  return (byEtabRows||[]).map(r=>{
    const H  = normalizePct(r.H);
    const L  = normalizePct(r.Pc);
    const Ld = normalizePct(r.Pd);
    const Tp = normalizePct(r.Tc);
    const Td = normalizePct(r.Td);
    const vals = [H,L,Ld,Tp,Td];
    const score = vals.length ? (vals.reduce((s,v)=>s+v,0)/vals.length) : 0;
    return { etablissement: r.etablissement, H, L, Ld, Tp, Td, score };
  }).sort((a,b)=> (a.score - b.score) || a.etablissement.localeCompare(b.etablissement));
}

// Rendu “faible taux de travail” + repères (moyenne & médiane régionales)
// Rendu “faible taux de travail” — repères = KPIs, filtrage = très faibles
function renderLowWorkTable(rows, kpi){
  const host = document.getElementById('inc');
  const KPI = kpi || {H:0,L:0,Ld:0,Tp:0,Td:0,score:0};

  // ===== Repères (IDENTIQUES aux KPIs tête de page)
  const repereHTML = `
    <div class="muted" style="margin:-4px 0 8px">
      Repères (KPIs — périmètre courant) :
      Heures <b>${fmt(KPI.H)}</b> •
      Leçons <b>${fmt(KPI.L)}</b> •
      Leçons dig. <b>${fmt(KPI.Ld)}</b> •
      TP <b>${fmt(KPI.Tp)}</b> •
      TP dig. <b>${fmt(KPI.Td)}</b> •
      Score <b>${fmt(KPI.score)}</b>
    </div>`;

  // ===== RÈGLE DE SÉLECTION “très faible”
  // 1) Score établissement STRICTEMENT inférieur à  min(50%, KPI.score - 15 pts)
  // 2) ET au moins 2 indicateurs individuels (H/L/Ld/Tp/Td) < (repère KPI - 10 pts)
  // -> repère exact et stable, facile à relire/adapter
  // ===== RÈGLE DE SÉLECTION “faible taux de travail” (plus inclusive)
const scoreThreshold = (Number(KPI.score) || 0) - 5;   // 5 points sous la synthèse
function isVeryLow(r){
  const badScore = Number.isFinite(r.score) && r.score <= scoreThreshold;
  const indicatorsBelowKpi = [
    r.H  < KPI.H,
    r.L  < KPI.L,
    r.Ld < KPI.Ld,
    r.Tp < KPI.Tp,
    r.Td < KPI.Td,
  ].filter(Boolean).length;

  // score franchement en dessous OU 3 indicateurs sur 5 sous les repères
  return badScore || indicatorsBelowKpi >= 3;
}


  // ne garder que les établissements “très faibles”
  const worst = (rows||[]).filter(isVeryLow)
    .sort((a,b)=> (a.score - b.score) || a.etablissement.localeCompare(b.etablissement,'fr'))
    .slice(0, 10);

  const body = worst.length ? worst.map(r=>`
    <tr>
      <td>${esc(r.etablissement||'')}</td>
      <td class="${heat(r.H)}"  style="text-align:right">${fmt(r.H)}</td>
      <td class="${heat(r.L)}"  style="text-align:right">${fmt(r.L)}</td>
      <td class="${heat(r.Ld)}" style="text-align:right">${fmt(r.Ld)}</td>
      <td class="${heat(r.Tp)}" style="text-align:right">${fmt(r.Tp)}</td>
      <td class="${heat(r.Td)}" style="text-align:right">${fmt(r.Td)}</td>
      <td class="${heat(r.score)}" style="text-align:right"><b>${fmt(r.score)}</b></td>
      <td><button class="btn soft mini" data-open-etab="${esc(r.etablissement||'')}">Détails</button></td>
    </tr>`).join('')
  : `<tr><td colspan="8" class="muted">Aucun établissement très faible pour ce périmètre.</td></tr>`;

  const html = `
    <section id="lowWork">
      <h4 style="margin:12px 0 6px">Établissements à <em>faible taux de travail</em></h4>
      ${repereHTML}
      <table class="table table-sm table-bordered align-middle">
        <thead>
          <tr>
            <th>Établissement</th>
            <th>Heures %</th>
            <th>Leçons %</th>
            <th>Leçons dig. %</th>
            <th>TP %</th>
            <th>TP dig. %</th>
            <th>Score</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </section>
  `;

  const old = host.querySelector('#lowWork');
  if (old) old.outerHTML = html;
  else host.insertAdjacentHTML('beforeend', html);
}




// === CLICK UNIQUE sur #inc : ouvre dépôt ou fiche établissement ===
document.getElementById('inc')?.addEventListener('click', (e)=>{
  const depBtn  = e.target.closest('[data-open-dep]');
  const etabBtn = e.target.closest('[data-open-etab]');

  if (depBtn){
    const id = depBtn.getAttribute('data-open-dep');
    if (id) openDeposit(id);
    return; // évite d'enchaîner avec l'autre test
  }
  if (etabBtn){
    const et = etabBtn.getAttribute('data-open-etab');
    if (et) openEtabDetails(et, ANNEE);
  }
});

function renderIncoherencesTable(items){
  if (!items.length){
    inc.innerHTML = '<div class="empty">Aucune incohérence détectée.</div>';
    return;
  }

  // Agrégation par discipline (on n'utilise plus coverage)
  const byDisc = new Map();
  for (const it of items){
    const k = String(it.nom||'').trim();
    if (!byDisc.has(k)){
      byDisc.set(k, { nom:k, presentIn:0, missingIn:0, classes:[], etabsBad:[] });
    }
    const r = byDisc.get(k);
    r.presentIn = Math.max(r.presentIn, Number(it.presentIn||0));
    r.missingIn = Math.max(r.missingIn, Number(it.missingIn||0));
    if (it.classe) r.classes.push(it.classe);

    if (it.missing){
      r.etabsBad.push({
        etab : it.etab || '',
        ap   : it.ap   || '',
        depId: it.depId || ''
      });
    }
  }

  const rows = [...byDisc.values()]
    // tri: d'abord ceux qui manquent le plus, puis par nom
    .sort((a,b)=> (b.missingIn - a.missingIn) || a.nom.localeCompare(b.nom,'fr'))
    .map(x=>{
      const uniqClasses = Array.from(new Set(x.classes||[]));

      // dédup établissements: clé = etab|ap
      const uniqEtabs = Array.from(new Map((x.etabsBad||[]).map(e=>{
        const key = [String(e.etab||'').trim(), String(e.ap||'').trim()].join('|');
        return [key, e];
      })).values());

      const etabsHtml = uniqEtabs.length
        ? uniqEtabs.map(e=>{
            const label = esc(e.etab || '—') + (e.ap ? ` <span class="badge">${esc(e.ap)}</span>` : '');
            return e.depId
              ? `<button class="btn soft mini" data-open-dep="${esc(e.depId)}" title="Ouvrir le dépôt">${label}</button>`
              : `<button class="btn soft mini" data-open-etab="${esc(e.etab||'')}" title="Voir l’établissement">${label}</button>`;
          }).join(' ')
        : '—';

      // (optionnel) colonne “Reçus/Attendus”
      const expected = (x.presentIn||0) + (x.missingIn||0);
      const receivedSlashExpected = `${x.presentIn||0} / ${expected}`;

      return `
        <tr>
          <td>${esc(x.nom)}</td>
          <td class="text-center">${x.presentIn||0}</td>
          <td class="text-center">${x.missingIn||0}</td>
          <td class="text-center">${receivedSlashExpected}</td>
          <td>${uniqClasses.length ? uniqClasses.map(c=>`<span class="badge">${esc(c)}</span>`).join(' ') : '—'}</td>
          <td>${etabsHtml}</td>
        </tr>`;
    }).join('');

  inc.innerHTML = `
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead>
          <tr>
            <th>Discipline</th>
            <th>Présente dans</th>
            <th>Absente dans</th>
            <th>Reçus / Attendus</th>
            <th>Classes concernées</th>
            <th>Établissements défaillants</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}



function collectIncoherences(data){
  const list = [];
  (Array.isArray(data)? data : [data]).forEach(cls=>{
    (cls?.incoherences||[]).forEach(it=>{
      // Étend en une ligne par établissement manquant
      const details = Array.isArray(it.details) ? it.details : [];
      if (details.length === 0){
        // on garde une ligne “agrégée” sans cible si pas de détails
        list.push({ 
          nom: it.nom, classe: cls?.classe, 
          presentIn: it.presentIn, missingIn: it.missingIn, coverage: it.coverage
        });
      }else{
        for (const d of details){
          list.push({
            nom: it.nom, classe: cls?.classe,
            presentIn: it.presentIn, missingIn: it.missingIn, coverage: it.coverage,
            etab: d.etab || '', ap: d.ap || '', depId: d.depId || '', missing: true
          });
        }
      }
    });
  });
  return list;
}



    async function renderForNode(node){
      kScope.textContent = `${currentPeriodLabel()} — ${node.meta.type==='region'?'Toute la région':node.label}`;

      const qs=currentQS();
      const filter = {};
      if(node.meta.type==='cycle'){ filter.cycle = node.meta.cycle; }
      if(node.meta.type==='spec'){  filter.cycle = node.meta.cycle; filter.specialite = node.meta.spec; }
      if(node.meta.type==='class'){ filter.cycle = node.meta.cycle; filter.specialite = node.meta.spec; }

 if(node.meta.type==='class'){
   filter.cycle = node.meta.cycle;
   filter.specialite = node.meta.spec;
  filter.classe = node.meta.classe; // <<< AJOUT
 }


      // KPIs (historique)
      try{
        const K = await api('/api/summary/kpis?'+new URLSearchParams({ ...qs, ...filter }).toString());
        kE.textContent   = K.etablissements ?? '—';
        kAP.textContent  = K.apActifs ?? '—';
        kD.textContent   = K.depots ?? '—';
        kEl.textContent  = K.effectifsRegion?.eleves ?? '—';
        kEns.textContent = K.effectifsRegion?.enseignantsEnPoste ?? '—';
        kH.textContent   = isFinite(K.taux?.couvertureHeures)?K.taux.couvertureHeures.toFixed(1)+'%':'—';
        kL.textContent   = isFinite(K.taux?.leconsFaites)?K.taux.leconsFaites.toFixed(1)+'%':'—';
        kLd.textContent  = isFinite(K.taux?.leconsDigitalFaites)?K.taux.leconsDigitalFaites.toFixed(1)+'%':'—';
        kTp.textContent  = isFinite(K.taux?.tpFaits)?K.taux.tpFaits.toFixed(1)+'%':'—';
        kTd.textContent  = isFinite(K.taux?.tpDigitalFaits)?K.taux.tpDigitalFaits.toFixed(1)+'%':'—';
        kR.textContent   = isFinite(K.taux?.reussite)?K.taux.reussite.toFixed(1)+'%':'—';
// ---- Synchronise les repères avec les KPIs affichés (même périmètre)
const KPI_H  = Number.isFinite(K?.taux?.couvertureHeures)     ? Number(K.taux.couvertureHeures)    : 0;
const KPI_L  = Number.isFinite(K?.taux?.leconsFaites)         ? Number(K.taux.leconsFaites)        : 0;
const KPI_Ld = Number.isFinite(K?.taux?.leconsDigitalFaites)  ? Number(K.taux.leconsDigitalFaites) : 0;
const KPI_Tp = Number.isFinite(K?.taux?.tpFaits)              ? Number(K.taux.tpFaits)             : 0;
const KPI_Td = Number.isFinite(K?.taux?.tpDigitalFaits)       ? Number(K.taux.tpDigitalFaits)      : 0;

// “score synthèse” = moyenne arithmétique des 5 indicateurs de réalisation
const KPI_SCORE = [KPI_H, KPI_L, KPI_Ld, KPI_Tp, KPI_Td].reduce((s,v)=>s+(Number.isFinite(v)?v:0),0) / 5;

GLOBAL_KPI = { H: KPI_H, L: KPI_L, Ld: KPI_Ld, Tp: KPI_Tp, Td: KPI_Td, score: KPI_SCORE };



      }catch(_){}

      /* ===== Carte scolaire ===== */
      try{
        const dataCarte = await loadCarteInspection(filter, qs);

        if (!dataCarte || !dataCarte.rows || !dataCarte.rows.length){
          mapBox.innerHTML = '<div class="empty">Aucune donnée.</div>';
        } else {
          const S = dataCarte.stats || {};
          if (Number(S?.etablissements) > 0) kE.textContent  = S.etablissements;
         if (Number(S?.apActifs)       > 0) kAP.textContent = S.apActifs;

          const rows = [...dataCarte.rows].sort((a,b)=> (a.etablissement||'').localeCompare(b.etablissement||''));

          // Élèves
          const elevesTotal = (S.eleves && S.eleves.total != null)
            ? S.eleves.total
            : rows.reduce((sum,r)=>{
                const f = Number(r.filles)||0, g = Number(r.garcons)||0;
                const e = Number(r.eleves);
                return sum + (Number.isFinite(e) && e>0 ? e : (f+g));
              }, 0);
          if (Number(elevesTotal) > 0) kEl.textContent = elevesTotal;

          // ===== Staff : construit un dictionnaire pour la table et les KPI
          const staffCounts = {};
          await Promise.all(rows.map(async r=>{
            const name = r.etablissement || '';
            let tot=0, pos=0;

            const staffInline = getStaffArray(r);
            if (staffInline.length){
              tot = staffInline.length;
              pos = staffInline.filter(isEnPoste).length;
            }else{
              const c = await getEtabStaffCounts(name); // fallback API détail
              tot = c.tot; pos = c.pos;
            }
            if (!tot) tot = Number(r.enseignantsTotaux)||0;
            if (!pos) pos = Number(r.enseignantsEnPoste)||0;

            staffCounts[name] = {tot, pos};
          }));

          const enPosteTotal = (S.enseignants && S.enseignants.enPoste != null)
            ? S.enseignants.enPoste
            : Object.values(staffCounts).reduce((s,x)=> s + (Number(x?.pos)||0), 0);
          if (Number(enPosteTotal) > 0) kEns.textContent = enPosteTotal;

          // Tableau
         mapBox.innerHTML = `
  <table id="tblMap">
    <thead>
      <tr>
        <th>Établissement</th>
        <th>Cycles ouverts</th>
        <th>Classes ouvertes</th>
        <th>Filles</th>
        <th>Garçons</th>
        <th>Élèves</th>
        <th>Ens. totaux</th>
        <th>En poste</th>
        <th>AP #</th>
        <th></th>
        <th>Suppr.</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>{
        const cycles  = Array.isArray(r.cycles)? r.cycles : (r.cycle?[r.cycle]:[]);
        const classes = Array.isArray(r.classes)? r.classes : [];
        const apCount = Array.isArray(r.ap)? r.ap.length : (Number(r.ap)||0);
        const filles  = Number(r.filles)||0;
        const garcons = Number(r.garcons)||0;
        const eleves  = Number(r.eleves) || (filles+garcons);
       const sc = staffCounts[r.etablissement] || {tot:(Number(r.enseignantsTotaux)||0), pos:(Number(r.enseignantsEnPoste)||0)};
const etabRaw = r.etablissement || '';
const etab    = esc(etabRaw || '—');
const lastId  = r.lastCardId ? esc(r.lastCardId) : '';
return `
  <tr>
    <td>${etab}</td>
            <td>${esc(cycles.join(', '))}</td>
            <td>${esc(classes.join(', '))}</td>
            <td>${filles}</td>
            <td>${garcons}</td>
            <td><b>${eleves}</b></td>
            <td>${sc.tot||0}</td>
            <td>${sc.pos||0}</td>
            <td>${apCount}</td>
           <td><button class="btn soft det" data-etab="${(etabRaw||'').replace(/"/g,'&quot;')}" title="Voir le détail">Détails</button></td>
            <td>
              ${ lastId
                ? `<button class="btn" data-del-card="${lastId}" title="Supprimer la dernière carte de ${etab}">🗑️</button>`
                : '<span class="muted">—</span>'
              }
            </td>
          </tr>`;
      }).join('')}
    </tbody>
  </table>`;


          document.getElementById('btnExportMap').onclick =
            ()=> downloadCsv(tableToCsv(document.getElementById('tblMap')), 'carte_scolaire.csv');
          document.getElementById('btnPrintMap').onclick  =
            ()=> printElement(document.getElementById('tblMap'), 'Carte scolaire — inspection');

          mapBox.querySelectorAll('.det').forEach(b=>{
           b.addEventListener('click', ()=> openEtabDetails(b.dataset.etab, ANNEE));
          });
        }
      }catch(e){
        mapBox.innerHTML = '<div class="empty">Carte scolaire indisponible.</div>';
      }

// suppression carte scolaire
// === suppression carte scolaire (robuste + délégation) ===
// on écoute les clics sur le conteneur, ça marche même après re-render
mapBox.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('[data-del-card]');
  if (!btn) return;

  const cardId = btn.getAttribute('data-del-card') || '';
  // on tente aussi de récupérer l'établissement (sert pour fallback)
  const tr = btn.closest('tr');
  const etabName = tr ? (tr.children[0]?.textContent?.trim() || '') : '';

  if (!cardId && !etabName) return;
  if (!confirm('Supprimer définitivement cette carte scolaire ?')) return;

  // petite désactivation visuelle
  const oldHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '…';

  async function tryDelete(url){
    const r = await fetch(url, { method:'DELETE', credentials:'same-origin' });
    let j = null;
    try { j = await r.json(); } catch(_) {}
    return { ok: r.ok && (j?.ok !== false), j };
  }

  try{
    // 1) DELETE /api/inspecteur/carte-scolaire/:id
    if (cardId){
      let { ok } = await tryDelete('/api/inspecteur/carte-scolaire/'+encodeURIComponent(cardId));
      // 2) si ça échoue, on tente DELETE /api/inspecteur/carte-scolaire?id=...
      if (!ok){
        ({ ok } = await tryDelete('/api/inspecteur/carte-scolaire?id='+encodeURIComponent(cardId)));
      }
      // 3) si toujours pas ok et qu'on a l'établissement, tenter “last by etab”
      if (!ok && etabName){
        ({ ok } = await tryDelete('/api/inspecteur/carte-scolaire/last?etablissement='+encodeURIComponent(etabName)));
      }
      if (!ok) throw new Error('delete failed');
    }else if (etabName){
      // cas sans id: supprimer la dernière carte de l’établissement
      const { ok } = await tryDelete('/api/inspecteur/carte-scolaire/last?etablissement='+encodeURIComponent(etabName));
      if (!ok) throw new Error('delete failed');
    }

    toast('Carte supprimée');
    await renderForNode(_activeNode); // rafraîchit KPIs + tableau

  }catch(e){
    alert('Suppression impossible : ' + (e?.message || ''));
    btn.disabled = false;
    btn.innerHTML = oldHtml;
    return;
  }
});



      // ===== Synthèse (form-view) =====
      if (node.meta.type==='region'){
        syn.innerHTML='<div class="empty">Sélectionne un cycle, une spécialité ou une classe à gauche.</div>';
        inc.innerHTML='<div class="empty">Aucune analyse (périmètre trop large).</div>';
      }else{
        let data=[];
        const qsStr = (extra)=> new URLSearchParams({ ...(qs||{}), ...(extra||{}) }).toString();
        try{
          if (node.meta.type==='cycle'){
            const cyc = node.meta.cycle;
            const S = (_topology?.cycles||[]).find(x=>x.key===cyc)?.specialites||[];
            for (const s of S){
              const res = await api('/api/summary/form-view?'+qsStr({ cycle:cyc, specialite:s.key }));
              if (Array.isArray(res)) data.push(...res); else data.push(res);
            }
          }else if (node.meta.type==='spec'){
            const res = await api('/api/summary/form-view?'+qsStr({ cycle:node.meta.cycle, specialite:node.meta.spec }));
            data = Array.isArray(res)? res : [res];
          }else{
            const res = await api('/api/summary/form-view?'+qsStr({ cycle:node.meta.cycle, specialite:node.meta.spec, classe:node.meta.classe }));
            data = Array.isArray(res)? res : [res];
          }
        }catch(_){ data=[]; }

        if(!data.length){
          syn.innerHTML='<div class="empty">Aucune donnée pour ce périmètre.</div>';
          inc.innerHTML='<div class="empty">—</div>';
        }else{
          const blocks = data.map(cls=>{
            const rows = (cls.disciplines||[]).map(d=>discRow(d)).join('');

            const T = cls.total || {};
            const sums = sumDiscs(cls.disciplines || []);

            const effHint = hintEffectifClasse(cls);
            const capFallback = capComposeTotaux(T.Comp, T.M10, effHint);

            const compCap = (sums.CompMax > 0) ? sums.CompMax : capFallback.comp;
            const m10Cap  = Math.min((sums.M10Max > 0 ? sums.M10Max : capFallback.m10), compCap);

            const H  = pct(T.Hd||0,  T.Hf||0);
            const L  = pct(T.Lp||0,  T.Lf||0);
            const Ld = pct(T.Ldp||0, T.Ldf||0);
            const Tp = pct(T.Tp||0,  T.Tf||0);
            const Td = pct(T.Tdp||0, T.Tdf||0);
            const R  = pct(compCap||0, m10Cap||0);
            const A  = pct(T.EffT||0, T.EffP||0);

            return `<details open style="margin-bottom:10px">
  <summary><strong>${esc(cls.classe||'Classe')}</strong> <span class="muted">(${cls.etablissements||0} établ.)</span></summary>
  <table class="tblSynth">
    ${headForm('Module / Discipline')}
    <tbody>
      ${rows}
      <tr style="background:#f6f6f6;font-weight:600">
        <td>Total ${esc(cls.classe||'')}</td>
        <td>${T.Hd||0}</td><td>${T.Hf||0}</td><td class="${heat(H)}">${fmt(H)}</td>
        <td>${T.Lp||0}</td><td>${T.Lf||0}</td><td class="${heat(L)}">${fmt(L)}</td>
        <td>${T.Ldp||0}</td><td>${T.Ldf||0}</td><td class="${heat(Ld)}">${fmt(Ld)}</td>
        <td>${T.Tp||0}</td><td>${T.Tf||0}</td><td class="${heat(Tp)}">${fmt(Tp)}</td>
        <td>${T.Tdp||0}</td><td>${T.Tdf||0}</td><td class="${heat(Td)}">${fmt(Td)}</td>
        <td>${compCap||0}</td><td>${m10Cap||0}</td><td class="${heat(R)}">${fmt(R)}</td>
        <td>${T.EffT||0}</td><td>${T.EffP||0}</td><td class="${heat(A)}">${fmt(A)}</td>
      </tr>
    </tbody>
  </table>
</details>`;
          });

         syn.innerHTML = blocks;

          document.getElementById('btnCsv').onclick=()=>{
            const firstTbl=document.querySelector('.tblSynth'); if(!firstTbl) return;
            downloadCsv(tableToCsv(firstTbl), 'synthese.csv');
          };
          document.getElementById('btnPrint').onclick=()=>{
            const container=document.getElementById('syn'); printElement(container, 'Synthèse');
          };

         // ✅ Utiliser la réponse du backend: form.incoherences
const inco = collectIncoherences(data);
renderIncoherencesTable(inco);
// --- Low progression by établissement
// ===== Faible taux de travail par établissement (dans le périmètre courant)
// ===== Faible taux de travail (réalisations) sur TOUS les dépôts du périmètre =====
try{
  const qs = currentQS();
  const filter = {};
  if (node.meta.type==='cycle'){ filter.cycle = node.meta.cycle; }
  if (node.meta.type==='spec' ){ filter.cycle = node.meta.cycle; filter.specialite = node.meta.spec; }
  if (node.meta.type==='class'){ filter.cycle = node.meta.cycle; filter.specialite = node.meta.spec; filter.classe = node.meta.classe; }

 const lowRows = await buildEtabWorkStats(filter, qs);
renderLowWorkTable(lowRows, GLOBAL_KPI);
}catch(e){
  const host = document.getElementById('inc');
  const old  = host.querySelector('#lowWork');
  if (old) old.remove();
}

try{
  const qsStr = (extra)=> new URLSearchParams({ ...(currentQS()||{}), ...(extra||{}) }).toString();
  const progress = await api('/api/summary/progress?' + qsStr(filter));
  renderLowProgressTable(progress?.rows || []);
}catch(_){}
        }
      }

      // mailbox dépôts
      await loadDeposits(filter, qs);
    }

    /* ===== Dépôts (mailbox) — avec pagination ===== */
const mailList  = document.getElementById('mailList');
const mailEmpty = document.getElementById('mailEmpty');
const depPrev   = document.getElementById('depPrev');
const depNext   = document.getElementById('depNext');
const depInfo   = document.getElementById('depInfo');
const depLimit  = document.getElementById('depLimit');

let DEP_PAGE = 1;
let DEP_TOTAL = 0;
let DEP_LIMIT = parseInt(depLimit?.value || '20', 10);

function updatePager(){
  const totalPages = Math.max(1, Math.ceil(DEP_TOTAL / Math.max(1, DEP_LIMIT)));
  depInfo.textContent = `Page ${DEP_PAGE} / ${totalPages} • ${DEP_TOTAL} dépôt(s)`;
  depPrev.disabled = (DEP_PAGE <= 1);
  depNext.disabled = (DEP_PAGE >= totalPages);
}

async function loadDeposits(filter, qs){
  const q = new URLSearchParams({ ...(filter||{}), ...(qs||{}), page:String(DEP_PAGE), limit:String(DEP_LIMIT) });
  try{
    const res = await api('/api/summary/deposits?'+q.toString());
    const rows  = res.rows || [];
    DEP_TOTAL   = Number(res.total||0);
    DEP_LIMIT   = Number(res.limit||DEP_LIMIT);
    DEP_PAGE    = Number(res.page || DEP_PAGE);

    mailList.innerHTML = '';
    if(!rows.length){
      mailEmpty.style.display='block';
      updatePager();
      return;
    }
    mailEmpty.style.display='none';

    rows.forEach(r=>{
      const when = new Date(r.createdAt).toLocaleString();
      const div = document.createElement('div');
      div.className='mail';
      div.dataset.id = r.id;
      div.innerHTML = `
        <div class="sujet">${esc(r.etablissement)} — <span class="muted">Éval ${r.evaluation ?? '—'}</span>
          <span class="badge">${esc(r.cycle)}</span>
          <span class="badge">${esc(r.specialite)}</span>
        </div>
        <div class="sub">
          ${esc(r.animateur||'—')} • ${when} • ${r.classes||0} classe(s)
          <button class="btn soft" style="float:right" title="Supprimer ce dépôt" data-del-depot="${esc(r.id)}">🗑️</button>
        </div>`;

      // ouvrir le dépôt
      div.addEventListener('click', ()=> openDeposit(r.id));

      // suppression (écouteur DANS la boucle — bon scope)
      div.querySelector('[data-del-depot]')?.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const id = ev.currentTarget.getAttribute('data-del-depot');
        if (!confirm('Supprimer définitivement ce dépôt ?')) return;
        try{
          const r = await fetch('/api/inspecteur/deposits/'+encodeURIComponent(id), {
            method:'DELETE', credentials:'same-origin'
          });
          const j = await r.json();
          if (!r.ok || !j.ok) throw new Error(j.error||'delete failed');
          toast('Dépôt supprimé');
          await loadDeposits(filter, qs);   // recharge la liste
          await renderForNode(_activeNode); // maj KPI/carte/synthèse
        }catch(e){
          alert('Suppression impossible : ' + (e.message||''));
        }
      });

      mailList.appendChild(div);
    });

    updatePager();
  }catch(e){
    mailList.innerHTML = '<div class="empty">Erreur chargement dépôts.</div>';
    depInfo.textContent = 'Erreur';
  }
}


document.getElementById('btnRefreshDepots').onclick = ()=>{
  DEP_PAGE = 1;
  _activeNode && renderForNode(_activeNode);
};

depPrev?.addEventListener('click', ()=>{
  if (DEP_PAGE > 1) { DEP_PAGE--; _activeNode && renderForNode(_activeNode); }
});
depNext?.addEventListener('click', ()=>{
  const totalPages = Math.max(1, Math.ceil(DEP_TOTAL / Math.max(1, DEP_LIMIT)));
  if (DEP_PAGE < totalPages) { DEP_PAGE++; _activeNode && renderForNode(_activeNode); }
});
depLimit?.addEventListener('change', ()=>{
  DEP_LIMIT = parseInt(depLimit.value||'20',10);
  DEP_PAGE = 1;
  _activeNode && renderForNode(_activeNode);
});


    /* ===== Overlay dépôt ===== */
    const ov = document.getElementById('ov');
    const ovClose = document.getElementById('ovClose');
    const ovTitle = document.getElementById('ovTitle');
    const ovMeta  = document.getElementById('ovMeta');
    const paneOverview = document.getElementById('paneOverview');
    const paneClasses  = document.getElementById('paneClasses');
    const paneFiles    = document.getElementById('paneFiles');
    const paneRaw      = document.getElementById('paneRaw');
    const rawJson      = document.getElementById('rawJson');

    const tabOverview=document.getElementById('tabOverview');
    const tabClasses =document.getElementById('tabClasses');
    const tabFiles   =document.getElementById('tabFiles');
    const tabRaw     =document.getElementById('tabRaw');

    function setOvTab(which){
      [tabOverview,tabClasses,tabFiles,tabRaw].forEach(t=>t.classList.remove('active'));
      [paneOverview,paneClasses,paneFiles,paneRaw].forEach(p=>p.style.display='none');
      const map={overview:[tabOverview,paneOverview], classes:[tabClasses,paneClasses], files:[tabFiles,paneFiles], raw:[tabRaw,paneRaw]};
      map[which][0].classList.add('active'); map[which][1].style.display='';
    }
    tabOverview.onclick=()=>setOvTab('overview');
    tabClasses.onclick =()=>setOvTab('classes');
    tabFiles.onclick   =()=>setOvTab('files');
    tabRaw.onclick     =()=>setOvTab('raw');

    ovClose.onclick = ()=> ov.style.display='none';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.style.display='none'; });



    // ---- helpers “brut → nombres”
    const getN = (obj, ...keys) => {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null && String(v).trim?.()!=='') return Number(v)||0;
      }
      return 0;
    };
    function sumDiscs(discs){
      const T = {
        Hd:0,Hf:0, Lp:0,Lf:0, Ldp:0,Ldf:0, Tp:0,Tf:0, Tdp:0,Tdf:0,
        Comp:0, M10:0, EffT:0, EffP:0,
        CompMax:0, M10Max:0
      };
      discs.forEach(d=>{
        const hd  = getN(d,'hD','Hd','heuresDues');
        const hf  = getN(d,'hF','Hf','heuresFaites');
        const lp  = getN(d,'lp','Lp','leconsPrevues');
        const lf  = getN(d,'lf','Lf','leconsFaites');
        const ldp = getN(d,'ldp','Ldp','leconsDigPrevues','leconsDigitaliseesPrevues');
        const ldf = getN(d,'ldf','Ldf','leconsDigFaites','leconsDigitaliseesFaites');
        const tp  = getN(d,'tp','Tp','tpPrevus');
        const tf  = getN(d,'tf','Tf','tpFaits');
        const tdp = getN(d,'tdp','Tdp','tpDigPrevus','tpDigitalisesPrevus');
        const tdf = getN(d,'tdf','Tdf','tpDigFaits','tpDigitalisesFaits');

        const comp = getN(d,'comp','Comp','elevesComposes','eleves');
        const m10  = getN(d,'m10','M10');

        const effT = getN(d,'effTot','EffT','ensTot','enseignantsTotaux');
        const effP = getN(d,'effPos','EffP','ensPoste','enseignantsEnPoste');

        T.Hd+=hd; T.Hf+=hf; T.Lp+=lp; T.Lf+=lf; T.Ldp+=ldp; T.Ldf+=ldf;
        T.Tp+=tp; T.Tf+=tf; T.Tdp+=tdp; T.Tdf+=tdf;

        T.Comp+=comp; T.M10+=m10;
        T.EffT+=effT; T.EffP+=effP;

        if (comp > T.CompMax) T.CompMax = comp;
        if (m10  > T.M10Max)  T.M10Max  = m10;
      });
      return T;
    }

/* ===== Repères & agrégation à partir de TOUS les dépôts ===== */

// Moyenne + médiane (repères fiables)
function meanMedian(arr){
  const a = (arr||[]).map(Number).filter(n=>Number.isFinite(n)).sort((x,y)=>x-y);
  const n = a.length || 1;
  const avg = a.reduce((s,v)=>s+v,0) / n;
  const med = (n%2 ? a[(n-1)/2] : (a[n/2-1]+a[n/2])/2) || 0;
  return { avg, med };
}

// 1) Récupère toutes les pages de /api/summary/deposits pour un filtre/période
async function fetchAllDepositsFor(filter, qs){
  const out = [];
  let page = 1;
  const limit = 200;
  while (true){
    const q = new URLSearchParams({ ...(filter||{}), ...(qs||{}), page:String(page), limit:String(limit) });
    const res = await api('/api/summary/deposits?' + q.toString()).catch(()=>({rows:[]}));
    const rows = Array.isArray(res?.rows) ? res.rows : [];
    if (!rows.length) break;
    out.push(...rows);
    const total = Number(res.total||0);
    if (page * limit >= total) break;
    page++;
  }
  return out;
}

// 2) Somme les compteurs d’un dépôt (depuis le JSON détaillé)
function sumDeposit(deposit){
  const acc = { Hd:0,Hf:0, Lp:0,Lf:0, Ldp:0,Ldf:0, Tp:0,Tf:0, Tdp:0,Tdf:0 };
  const classes = Array.isArray(deposit?.classes) ? deposit.classes : [];
  for (const c of classes){
    const discs = Array.isArray(c?.disciplines) ? c.disciplines
                : (Array.isArray(c?.modules) ? c.modules : []);
    for (const d of discs){
      acc.Hd  += getN(d,'hD','Hd','heuresDues');
      acc.Hf  += getN(d,'hF','Hf','heuresFaites');
      acc.Lp  += getN(d,'lp','Lp','leconsPrevues');
      acc.Lf  += getN(d,'lf','Lf','leconsFaites');
      acc.Ldp += getN(d,'ldp','Ldp','leconsDigPrevues','leconsDigitaliseesPrevues');
      acc.Ldf += getN(d,'ldf','Ldf','leconsDigFaites','leconsDigitaliseesFaites');
      acc.Tp  += getN(d,'tp','Tp','tpPrevus');
      acc.Tf  += getN(d,'tf','Tf','tpFaits');
      acc.Tdp += getN(d,'tdp','Tdp','tpDigPrevus','tpDigitalisesPrevus');
      acc.Tdf += getN(d,'tdf','Tdf','tpDigFaits','tpDigitalisesFaits');
    }
  }
  return acc;
}

// 3) Construit les % par établissement à partir de l’ensemble des dépôts
async function buildEtabWorkStats(filter, qs){
  const list = await fetchAllDepositsFor(filter, qs);
  const byId = new Map();

  for (const r of list){
    let full = null;
    try { full = await api('/api/summary/deposits/'+ encodeURIComponent(r.id)); }
    catch(_) { continue; }

    const etab = full?.etablissement || r?.etablissement || '—';
    const add  = sumDeposit(full);
    const acc  = byId.get(etab) || { etab, Hd:0,Hf:0, Lp:0,Lf:0, Ldp:0,Ldf:0, Tp:0,Tf:0, Tdp:0,Tdf:0 };
    for (const k of Object.keys(add)) acc[k] += Number(add[k]||0);
    byId.set(etab, acc);
  }

  // % + score moyen
  const rows = Array.from(byId.values()).map(x=>{
    const H  = pct(x.Hd,  x.Hf);
    const L  = pct(x.Lp,  x.Lf);
    const Ld = pct(x.Ldp, x.Ldf);
    const Tp = pct(x.Tp,  x.Tf);
    const Td = pct(x.Tdp, x.Tdf);
    const vals = [H,L,Ld,Tp,Td];
    const score = vals.reduce((s,v)=>s+v,0) / vals.length;
    return { etablissement:x.etab, H, L, Ld, Tp, Td, score };
  });

  // tri du plus faible au plus élevé
  rows.sort((a,b)=> (a.score - b.score) || a.etablissement.localeCompare(b.etablissement,'fr'));
  return rows;
}



    // ===== Helpers anti double-compte
    function hintEffectifClasse(cls){
      const tryVals = [
        cls?.eleves, cls?.effectif, cls?.totalEleves, cls?.total?.Eleves, cls?.total?.eleves,
        Array.isArray(cls?.effectifs)
          ? cls.effectifs.reduce((s,e)=> s + Number(e?.total ?? ((e?.filles||0)+(e?.garcons||0))), 0)
          : 0
      ];
      for (const v of tryVals){
        const n = Number(v);
        if (Number.isFinite(n) && n > 0) return n;
      }
      return null;
    }
    function capComposeTotaux(compBrut, m10Brut, effectifClasse){
      let comp = Number(compBrut||0);
      let m10  = Number(m10Brut||0);
      if (Number.isFinite(effectifClasse) && effectifClasse > 0){
        comp = Math.min(comp, effectifClasse);
      }
      m10 = Math.min(m10, comp);
      return { comp, m10 };
    }

    function fileRow(f){
      const row = document.createElement('div');
      row.className = 'fileRow';
      const url = f.path.startsWith('/uploads') ? f.path : '/uploads/'+f.path.replace(/^\/+/,'');

      row.innerHTML = `
        📄 <a href="${esc(url)}" target="_blank" rel="noopener">${esc(f.name||'fichier')}</a>
        <button class="btn soft del">Supprimer</button>
      `;
      row.querySelector('.del').addEventListener('click', async (e)=>{
        e.stopPropagation();
        if (!confirm('Supprimer définitivement ce fichier ?')) return;
        try{
          const qp = new URLSearchParams({ p: f.path.replace(/^\/?uploads\/?/,'') });
          const resp = await fetch('/api/uploads?'+qp.toString(), { method:'DELETE', credentials:'same-origin' });
          const j = await resp.json();
          if (!resp.ok || !j.ok) throw new Error(j.error||'delete failed');
          row.remove();
        }catch(err){
          alert('Suppression impossible: '+(err.message||'')); 
        }
      });
      return row;
    }

    function classTable(c){
      const discs = Array.isArray(c.disciplines) ? c.disciplines
                   : (Array.isArray(c.modules) ? c.modules : []);

      const rows = discs.map(d=>discRow({
        nom: d.discipline||d.nom||d.name,
        Hd:getN(d,'hD','Hd','heuresDues'),
        Hf:getN(d,'hF','Hf','heuresFaites'),
        Lp:getN(d,'lp','Lp','leconsPrevues'),
        Lf:getN(d,'lf','Lf','leconsFaites'),
        Ldp:getN(d,'ldp','Ldp','leconsDigPrevues','leconsDigitaliseesPrevues'),
        Ldf:getN(d,'ldf','Ldf','leconsDigFaites','leconsDigitaliseesFaites'),
        Tp:getN(d,'tp','Tp','tpPrevus'),
        Tf:getN(d,'tf','Tf','tpFaits'),
        Tdp:getN(d,'tdp','Tdp','tpDigPrevus','tpDigitalisesPrevus'),
        Tdf:getN(d,'tdf','Tdf','tpDigFaits','tpDigitalisesFaits'),
        Comp:getN(d,'comp','Comp','elevesComposes','eleves'),
        M10:getN(d,'m10','M10'),
        EffT:getN(d,'effTot','EffT','ensTot'),
        EffP:getN(d,'effPos','EffP','ensPoste')
      })).join('');

      const T = sumDiscs(discs);

      // Max anti double-compte
      let compCap = T.CompMax;
      let m10Cap  = Math.min(T.M10Max, compCap);

      // Fallback : borne par effectif saisi sur la classe (F/G)
      if (!compCap || compCap <= 0) {
        const hintFromClass = (Number(c?.F||c?.filles||0) + Number(c?.G||c?.garcons||0)) || null;
        const fallback = capComposeTotaux(T.Comp, T.M10, hintFromClass);
        compCap = fallback.comp;
        m10Cap  = Math.min(fallback.m10, compCap);
      }

      const H=pct(T.Hd||0,T.Hf||0), L=pct(T.Lp||0,T.Lf||0), Ld=pct(T.Ldp||0,T.Ldf||0),
            Tp=pct(T.Tp||0,T.Tf||0), Td=pct(T.Tdp||0,T.Tdf||0),
            R=pct(compCap||0,m10Cap||0), A=pct(T.EffT||0,T.EffP||0);

      return `<details open style="margin:8px 0">
        <summary><strong>${esc(c.nom||'Classe')}</strong> <span class="muted">(${discs.length} module(s))</span></summary>
        <table>${headForm('Module / Discipline')}<tbody>
          ${rows}
          <tr style="background:#f6f6f6;font-weight:600">
            <td>Total ${esc(c.nom||'')}</td>
            <td>${T.Hd}</td><td>${T.Hf}</td><td class="${heat(H)}">${fmt(H)}</td>
            <td>${T.Lp}</td><td>${T.Lf}</td><td class="${heat(L)}">${fmt(L)}</td>
            <td>${T.Ldp}</td><td>${T.Ldf}</td><td class="${heat(Ld)}">${fmt(Ld)}</td>
            <td>${T.Tp}</td><td>${T.Tf}</td><td class="${heat(Tp)}">${fmt(Tp)}</td>
            <td>${T.Tdp}</td><td>${T.Tdf}</td><td class="${heat(Td)}">${fmt(Td)}</td>
            <td>${compCap||0}</td><td>${m10Cap||0}</td><td class="${heat(R)}">${fmt(R)}</td>
            <td>${T.EffT}</td><td>${T.EffP}</td><td class="${heat(A)}">${fmt(A)}</td>
          </tr>
        </tbody></table>
      </details>`;
    }

    async function openDeposit(id){
      try{

        const d = await api('/api/summary/deposits/'+id);
        ovTitle.textContent = `${d.etablissement} — Éval ${d.evaluation}`;
        ovMeta.innerHTML = `<div><strong>Cycle:</strong> ${esc(d.cycle)} • <strong>Spécialité:</strong> ${esc(d.specialite)} • <strong>AP:</strong> ${esc(d.animateur||'—')}</div>
          <div><strong>Créé le:</strong> ${new Date(d.createdAt).toLocaleString()} • <strong>Année:</strong> ${esc(d.annee||'—')}</div>`;

        const nbClasses = (d.classes||[]).length;
        const nbFichiers = (d.files||[]).length;
        paneOverview.innerHTML = `<div class="card"><div><strong>${esc(d.etablissement)}</strong></div>
          <div class="muted">Éval ${esc(d.evaluation)} • ${nbClasses} classe(s) • ${nbFichiers} fichier(s)</div></div>`;

        paneClasses.innerHTML = (d.classes||[]).map(classTable).join('') || '<div class="empty">Aucune classe.</div>';

        paneFiles.innerHTML = '';
        if (!d.files || !d.files.length){ paneFiles.innerHTML = '<div class="empty">Aucun fichier.</div>'; }
        else d.files.forEach(f=> paneFiles.appendChild(fileRow(f)));

        rawJson.textContent = JSON.stringify(d, null, 2);

        setOvTab('overview');
        ov.style.display='flex';
      }catch(e){ alert('Erreur ouverture du dépôt.'); }
    }

// ===== Chat (socket.io) — AP aligné sur IPR

// ===== Chat (socket.io) — rendu AP (WhatsApp-like) =====
const CONNECTED_USER = <%- JSON.stringify({
  id:  (user && user.id) || '',
  nom: (user && user.nom) || '',
  etab: (user && user.etab) || '',
  role: 'insp',
  inspection: (user && user.inspection) || ''
}) %>;

// DOM
const msgsEl     = document.getElementById('msgs');
const chatFormEl = document.getElementById('chatForm');
const chatTextEl = document.getElementById('chatText');
const presenceEl = document.getElementById('presence');
const typingEl   = document.getElementById('typing');

const replyBar   = document.getElementById('replyBar');
const replyName  = document.getElementById('replyName');
const replySnip  = document.getElementById('replySnippet');
const replyCancel= document.getElementById('replyCancel');

const hhmm = ts => new Date(ts||Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const dayKey = ts => { const d=new Date(ts||Date.now()); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); };
const _esc = (typeof esc==='function') ? esc : (s)=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

let lastDayKey = '';
let REPLY_TARGET = null;

// Reply bar
function showReplyBar(target){
  REPLY_TARGET = target;
  replyName.textContent = target?.from || '—';
  replySnip.textContent = (target?.text || '').slice(0, 160);
  replyBar.classList.remove('hidden');
}
function hideReplyBar(){
  REPLY_TARGET = null;
  replyBar.classList.add('hidden');
  replyName.textContent = '—';
  replySnip.textContent = '—';
}
replyCancel?.addEventListener('click', hideReplyBar);

// Aller au message cité
function jumpToMessage(id){
  if(!id) return;
  const el = msgsEl.querySelector(`[data-mid="${CSS.escape(id)}"]`);
  if(!el) return;
  el.scrollIntoView({behavior:'smooth', block:'center'});
  el.classList.add('flash');
  setTimeout(()=> el.classList.remove('flash'), 1800);
}

// Rendu d'un message
// === Rendu d'un message (unique)
function initialsOf(name){
  const clean = String(name||'').trim()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'');
  const m = clean.match(/\p{L}/u);
  return (m ? m[0] : '?').toUpperCase();
}

function addMsg(m){
  if(!msgsEl) return;
  const ts = m.ts || m.createdAt || Date.now();
  const k  = dayKey(ts);
  if(k!==lastDayKey){
    msgsEl.insertAdjacentHTML('beforeend', `<div class="w-day">${new Date(ts).toLocaleDateString()}</div>`);
    lastDayKey = k;
  }

  const fromName = m.from || m?.auteur?.nom || '—';
  const authorId = m.uid || m.userId || m.auteur?.id || m.auteurId || m.fromId || '';
  const mine = authorId ? (authorId === CONNECTED_USER.id) : (fromName === CONNECTED_USER.nom);

  const q = (m.replyTo && (m.replyTo.text || m.replyTo.from)) ? `
    <div class="w-quote" data-ref="${_esc(m.replyTo.id||'')}" title="Afficher le message cité">
      <div class="q-name">${_esc(m.replyTo.from || '—')}</div>
      <div class="q-text">${_esc((m.replyTo.text||'').slice(0,160))}</div>
    </div>` : '';

  const avatarHTML = mine ? '' : `<div class="w-avatar-sm" aria-hidden="true">${initialsOf(fromName)}</div>`;

  const wrap = document.createElement('div');
  wrap.className = 'w-msg ' + (mine ? 'mine' : 'theirs');
  wrap.dataset.mid = m.id || m._id || String(ts);

  wrap.innerHTML = `
    ${avatarHTML}
    <div class="w-bubble">
      <div class="w-from">${_esc(mine ? 'Moi' : fromName)}</div>
      ${q}
      <div class="w-text">${_esc(m.text || m.texte || '')}</div>
      <div class="w-meta"><span class="w-time">${hhmm(ts)}</span>${mine?'<span class="w-ticks">✓✓</span>':''}</div>
    </div>`;
  msgsEl.appendChild(wrap);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}


// Click sur message : armer une réponse / ouvrir la citation
msgsEl?.addEventListener('click', (e)=>{
  const msg = e.target.closest('.w-msg');
  if(!msg) return;
  const quote = e.target.closest('.w-quote');
  if(quote && quote.dataset.ref){ jumpToMessage(quote.dataset.ref); return; }

  const id   = msg.dataset.mid || '';
  const from = msg.querySelector('.w-from')?.textContent?.replace(/^Moi$/,'Vous') || '—';
  const text = msg.querySelector('.w-text')?.textContent || '';
  showReplyBar({ id, from, text });
  chatTextEl?.focus();
});

// Socket.io
let socket;
try{
  socket = io({
    path: '/socket.io',
    transports: ['websocket','polling'],
    withCredentials: true,
    auth: { user: CONNECTED_USER }
  });
}catch(e){ console.warn('socket.io indisponible', e); }

if (socket){
  socket.on('connect', ()=>{
    presenceEl && (presenceEl.textContent = 'Connectés : —');
    socket.emit('chat:join', { inspection: CONNECTED_USER.inspection });
  });
  socket.on('disconnect', ()=> presenceEl && (presenceEl.textContent = 'Hors ligne'));
  socket.on('connect_error', ()=> chatTextEl && (chatTextEl.disabled = true));

  socket.on('chat:history', list=>{ msgsEl.innerHTML=''; lastDayKey=''; (Array.isArray(list)?list:[]).forEach(addMsg); });
  socket.on('chat:new', addMsg);
  socket.on('chat:error', e=> alert(e?.message||e?.error||'Erreur chat'));
  socket.on('presence:update', n=> presenceEl && (presenceEl.textContent = `Connectés : ${n}`));
socket.on('carte:updated',  ()=> _activeNode && renderForNode(_activeNode));
socket.on('carte:deleted',  ()=> _activeNode && renderForNode(_activeNode));
socket.on('deposit:deleted',()=> _activeNode && renderForNode(_activeNode));

  // typing
  let typingClear;
  socket.on('chat:typing', payload=>{
    const from = payload?.from||'Quelqu’un';
    if(from === CONNECTED_USER.nom) return;
    typingEl.textContent = payload?.typing ? `${from} est en train d’écrire…` : '';
    clearTimeout(typingClear);
    if(payload?.typing) typingClear = setTimeout(()=> typingEl.textContent='', 1200);
  });

  // refresh manuel
  document.getElementById('chatRefresh')?.addEventListener('click', ()=>{
    socket.emit('chat:join', { inspection: CONNECTED_USER.inspection });
  });
}

// === Purge du chat (IPR seulement) ===
const resetBtn = document.getElementById('chatResetBtn');
resetBtn?.addEventListener('click', async ()=>{
  const insp = CONNECTED_USER?.inspection || '';
  if (!insp) { alert('Inspection inconnue.'); return; }

  if (!confirm('Purger tout l’historique du salon IPR ⇄ AP pour cette inspection ?')) return;

  try{
    const qs = new URLSearchParams({ inspection: insp });
    const r  = await fetch('/api/chat/reset?' + qs.toString(), {
      method: 'DELETE',
      credentials: 'same-origin'
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok || j.ok === false) throw new Error(j.error || 'reset failed');

    // vide localement et redemande l’historique (désormais vide)
    msgsEl.innerHTML = '';
    lastDayKey = '';
    toast('Chat vidé.');
    socket?.emit('chat:join', { inspection: insp });
  }catch(e){
    alert('Purge impossible : ' + (e?.message || ''));
  }
});



// Emit “typing”
if (chatTextEl && socket){
  let typingTimer;
  chatTextEl.addEventListener('input', ()=>{
    socket.emit('chat:typing', { typing:true, from: CONNECTED_USER.nom });
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=> socket.emit('chat:typing', { typing:false, from: CONNECTED_USER.nom }), 800);
  });
}
// Enter pour envoyer (Shift+Enter = saut de ligne)
chatTextEl?.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); chatFormEl?.requestSubmit(); }
});
// Envoi message (+ éventuelle citation)
chatFormEl?.addEventListener('submit', (e)=>{
  e.preventDefault();
  const text = (chatTextEl?.value||'').trim();
  if(!text || !socket) return;

  const payload = {
    text,
    ts: Date.now(),
    client_msg_id: (crypto?.randomUUID?.() || (Date.now() + '-' + Math.random()))
  };
  if (REPLY_TARGET){
    payload.replyTo = { id: REPLY_TARGET.id||'', from: REPLY_TARGET.from||'', text: REPLY_TARGET.text||'' };
  }

  // on efface tout de suite (le serveur dédoublonne avec client_msg_id)
  chatTextEl.value = '';
  hideReplyBar();

  // ack optionnel si ton serveur le renvoie (sinon ça ne gêne pas)
  socket.emit('chat:send', payload, (ack)=>{
    if (ack?.error) {
      chatTextEl.value = text; // on restaure si erreur serveur
      alert('Envoi échoué: ' + ack.error);
    }
  });
});



// petits plus
document.getElementById('emojiBtn')?.addEventListener('click', ()=>{
  chatTextEl.value += (chatTextEl.value ? ' ' : '') + '🙂';
  chatTextEl.focus();
});
document.getElementById('attachBtn')?.addEventListener('click', ()=>{
  document.getElementById('chatFile')?.click();
});


    // ===== Tabs droite
    const tabChat=document.getElementById('tabChat'), tabDepots=document.getElementById('tabDepots');
    const paneChat=document.getElementById('paneChat'), paneDepots=document.getElementById('paneDepots');
    function setTab(which){
      [tabChat,tabDepots].forEach(t=>t.classList.remove('active'));
      [paneChat,paneDepots].forEach(p=>p.style.display='none');
      if(which==='chat'){ tabChat.classList.add('active'); paneChat.style.display='flex'; }
      if(which==='depots'){ tabDepots.classList.add('active'); paneDepots.style.display='block'; }
    }
    tabChat.onclick=()=>setTab('chat');
    tabDepots.onclick=()=>setTab('depots');

    // ===== Boot
    async function buildAndRender(){ await buildTree(); }
// Ajoute ?annee=YYYY-YYYY au lien "Fichier personnel" (si absent)
  (function () {
    const a = document.getElementById('btnStaff');
    if (!a) return;

    function schoolYear(d = new Date()) {
      const y = d.getFullYear();
      const m = d.getMonth(); // 0=janvier
      // année scolaire : d’août (7) à juillet (6)
      return (m >= 7) ? `${y}-${y + 1}` : `${y - 1}-${y}`;
    }

    const url = new URL(a.getAttribute('href'), location.origin);
    if (!url.searchParams.has('annee')) {
      url.searchParams.set('annee', schoolYear());
      a.setAttribute('href', url.pathname + '?' + url.searchParams.toString());
    }
  })();
/* ======= Purge Cartes scolaires ======= */
(function(){
  const btnOpen   = document.getElementById('btnPurgeCards');
  const modal     = document.getElementById('purgeModal');
  const closeBtn  = document.getElementById('purgeClose');
  const yearIn    = document.getElementById('purgeYear');
  const filterIn  = document.getElementById('purgeFilter');
  const reloadBtn = document.getElementById('purgeReload');
  const doBtn     = document.getElementById('purgeDo');
  const chkAll    = document.getElementById('purgeChkAll');
  const tbody     = document.querySelector('#purgeTable tbody');
  const emptyMsg  = document.getElementById('purgeEmpty');

  if (!btnOpen) return;

  function schoolYear(d=new Date()){
    const y=d.getFullYear(), m=d.getMonth();
    return (m>=7)?`${y}-${y+1}`:`${y-1}-${y}`;
  }
  yearIn.value = new URLSearchParams(location.search).get('annee') || schoolYear();

  function renderRows(rows){
    const q = filterIn.value.trim().toLowerCase();
    const filtered = q ? rows.filter(r => (r?.meta?.etablissement||'').toLowerCase().includes(q)) : rows;

    tbody.innerHTML = filtered.map(row=>{
      const m = row.meta || {};
      const id = row._id || row.id || '';
      const when = row.receivedAt ? new Date(row.receivedAt).toLocaleString() : '';
      return `<tr>
        <td style="text-align:center"><input type="checkbox" class="sel" value="${id}"></td>
        <td>${esc(m.etablissement||'')}</td>
        <td>${esc(m.annee||'')}</td>
        <td>${esc(m.cycle||'')}</td>
        <td>${esc(String(m.specialite||'').toUpperCase())}</td>
        <td style="text-align:center">${row.version||1}</td>
        <td>${esc(when)}</td>
      </tr>`;
    }).join('');

    emptyMsg.style.display = filtered.length ? 'none' : 'block';
  }

  async function loadList(){
    const qs = new URLSearchParams();
    if (yearIn.value) qs.set('annee', yearIn.value);
    // route "latest" = 1 carte par couple etab+annee+cycle+spec
    const res = await api('/api/inspecteur/carte-scolaire/latest?'+qs.toString()).catch(()=>({rows:[]}));
    renderRows(Array.isArray(res.rows)?res.rows:[]);
  }

  btnOpen.addEventListener('click', ()=>{ modal.style.display='flex'; loadList(); });
  closeBtn.addEventListener('click', ()=> modal.style.display='none');
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });

  reloadBtn.addEventListener('click', loadList);
  filterIn.addEventListener('input', ()=>{
    const rows = [...tbody.querySelectorAll('tr')].map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        _id: tr.querySelector('.sel')?.value,
        meta: { etablissement: tds[1]?.textContent||'', annee: tds[2]?.textContent||'', cycle: tds[3]?.textContent||'', specialite: tds[4]?.textContent||'' },
        version: tds[5]?.textContent||'',
        receivedAt: tds[6]?.textContent||''
      };
    });
    renderRows(rows);
  });

  chkAll.addEventListener('change', ()=>{
    document.querySelectorAll('#purgeTable .sel').forEach(c=> c.checked = chkAll.checked);
  });

  doBtn.addEventListener('click', async ()=>{
    const ids = [...document.querySelectorAll('#purgeTable .sel:checked')].map(x=>x.value).filter(Boolean);
    if (!ids.length) { alert('Sélectionnez au moins une carte.'); return; }
    if (!confirm(`Supprimer ${ids.length} carte(s) ? Cette action est irréversible.`)) return;

    doBtn.disabled = true;
    try{
      const r = await fetch('/api/inspecteur/carte-scolaire', {
        method: 'DELETE',
        headers: { 'Content-Type':'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ ids })
      });
      const j = await r.json();
      if (!r.ok || j.ok===false) throw new Error(j.error||'delete failed');
      toast(`Supprimées: ${j.deleted||ids.length}`);
      await loadList();
      if (_activeNode) await renderForNode(_activeNode); // refresh KPIs/table
    }catch(e){
      alert('Suppression impossible : ' + (e.message||''));
    }finally{
      doBtn.disabled = false;
    }
  });
})();

    buildAndRender();
  </script>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
